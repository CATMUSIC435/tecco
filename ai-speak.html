<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Offline TF.js - Giá»ng nÃ³i & Tá»± há»c</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen">
    <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-lg p-5 space-y-4">
        <h1 class="text-2xl font-bold text-center">ğŸ¤– Chatbot Offline (TF.js)</h1>

        <div id="chat" class="h-80 overflow-y-auto bg-gray-700 p-3 rounded space-y-2"></div>

        <div class="flex gap-2">
            <input id="input" type="text" placeholder="Há»i tÃ´i Ä‘iá»u gÃ¬ Ä‘Ã³..."
                class="flex-1 p-2 rounded bg-gray-600 focus:outline-none" />
            <button id="send" class="bg-blue-600 hover:bg-blue-500 px-3 rounded">Gá»­i</button>
            <button id="mic" class="bg-red-600 hover:bg-red-500 px-3 rounded">ğŸ¤</button>
        </div>
    </div>

    <script>
        // ---------------------------
        // ğŸ§© Dá»® LIá»†U CÆ  Báº¢N
        // ---------------------------
        let dataset = [
            { q: "xin chÃ o", a: "ChÃ o báº¡n, tÃ´i lÃ  chatbot offline!" },
            { q: "báº¡n tÃªn gÃ¬", a: "TÃ´i chÆ°a cÃ³ tÃªn, báº¡n muá»‘n Ä‘áº·t cho tÃ´i khÃ´ng?" },
            { q: "báº¡n lÃ m Ä‘Æ°á»£c gÃ¬", a: "TÃ´i cÃ³ thá»ƒ há»c tá»« báº¡n vÃ  trÃ² chuyá»‡n!" },
            { q: "táº¡m biá»‡t", a: "Táº¡m biá»‡t, háº¹n gáº·p láº¡i!" }
        ];

        // ---------------------------
        // ğŸ’¾ KHÃ”I PHá»¤C Dá»® LIá»†U ÄÃƒ LÆ¯U
        // ---------------------------
        const saved = localStorage.getItem("chatbot_memory");
        if (saved) dataset = JSON.parse(saved);

        let model;

        // ---------------------------
        // ğŸ”  CHUYá»‚N VÄ‚N Báº¢N THÃ€NH VECTOR
        // ---------------------------
        function textToVector(text) {
            const vec = new Array(50).fill(0);
            text.toLowerCase().split('').forEach((ch, i) => {
                vec[i % 50] += ch.charCodeAt(0) / 255;
            });
            return vec;
        }

        // ---------------------------
        // ğŸ§  Táº O HOáº¶C Táº¢I MÃ” HÃŒNH
        // ---------------------------
        async function initModel() {
            try {
                model = await tf.loadLayersModel('indexeddb://chatbot-model');
                console.log("âœ… ÄÃ£ táº£i model tá»« IndexedDB");
            } catch (e) {
                console.log("âš™ï¸ Táº¡o má»›i model...");
                model = tf.sequential();
                model.add(tf.layers.dense({ units: 16, inputShape: [50], activation: 'relu' }));
                model.add(tf.layers.dense({ units: dataset.length, activation: 'softmax' }));
                model.compile({ optimizer: 'adam', loss: 'categoricalCrossentropy' });
                await trainModel();
            }
        }

        async function trainModel() {
            const xs = tf.tensor2d(dataset.map(d => textToVector(d.q)));
            const ys = tf.tensor2d(dataset.map((_, i) => {
                const arr = new Array(dataset.length).fill(0);
                arr[i] = 1;
                return arr;
            }));
            await model.fit(xs, ys, { epochs: 30, verbose: 0 });
            await model.save('indexeddb://chatbot-model');
            console.log("ğŸ’¾ Model Ä‘Ã£ Ä‘Æ°á»£c lÆ°u vÃ o IndexedDB");
        }

        // ---------------------------
        // ğŸ’¬ HIá»‚N THá»Š TIN NHáº®N
        // ---------------------------
        function addMessage(text, from = "bot") {
            const chat = document.getElementById("chat");
            const msg = document.createElement("div");
            msg.className = from === "bot"
                ? "bg-blue-700 p-2 rounded max-w-xs"
                : "bg-gray-600 p-2 rounded max-w-xs ml-auto";
            msg.textContent = text;
            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        }

        // ---------------------------
        // ğŸ§© Dá»° ÄOÃN TRáº¢ Lá»œI
        // ---------------------------
        async function getAnswer(question) {
            const input = tf.tensor2d([textToVector(question)]);
            const output = model.predict(input);
            const index = output.argMax(1).dataSync()[0];
            const confidence = output.max().dataSync()[0];
            if (confidence < 0.5) return null;
            return dataset[index].a;
        }

        // ---------------------------
        // ğŸ—£ï¸ TEXT-TO-SPEECH
        // ---------------------------
        function speak(text) {
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = "vi-VN";
            msg.rate = 1;
            speechSynthesis.speak(msg);
        }

        // ---------------------------
        // ğŸ¤ SPEECH-TO-TEXT
        // ---------------------------
        function startListening() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'vi-VN';
              recognition.rate = 1;
            recognition.start();
            recognition.onresult = (e) => {
                const transcript = e.results[0][0].transcript;
                document.getElementById("input").value = transcript;
                document.getElementById("send").click();
            };
        }

        // ---------------------------
        // ğŸ§  Xá»¬ LÃ Gá»¬I CÃ‚U Há»I
        // ---------------------------
        document.getElementById("send").onclick = async () => {
            const input = document.getElementById("input");
            const question = input.value.trim();
            if (!question) return;
            addMessage(question, "user");
            input.value = "";

            let answer = await getAnswer(question);

            if (!answer) {
                answer = "TÃ´i chÆ°a hiá»ƒu cÃ¢u nÃ y, báº¡n cÃ³ thá»ƒ dáº¡y tÃ´i khÃ´ng?";
                addMessage(answer);
                speak(answer);

                // Tá»± há»c
                const reply = prompt("Nháº­p cÃ¢u tráº£ lá»i cho: \"" + question + "\"");
                if (reply) {
                    dataset.push({ q: question.toLowerCase(), a: reply });
                    localStorage.setItem("chatbot_memory", JSON.stringify(dataset));
                    await trainModel();
                    addMessage("Cáº£m Æ¡n! TÃ´i Ä‘Ã£ há»c thÃªm cÃ¢u má»›i. ğŸ¤–");
                    speak("Cáº£m Æ¡n, tÃ´i Ä‘Ã£ há»c thÃªm cÃ¢u má»›i!");
                }
            } else {
                addMessage(answer);
                speak(answer);
            }
        };

        document.getElementById("mic").onclick = startListening;

        // ---------------------------
        // ğŸš€ KHá»I Äá»˜NG
        // ---------------------------
        initModel();
    </script>
</body>

</html>