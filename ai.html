<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chatbox v·ªõi TensorFlow.js (USE)</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- TensorFlow.js & Universal Sentence Encoder -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder@1.3.3/dist/universal-sentence-encoder.min.js"></script>

    <style>
        body {
            font-family: Inter, system-ui, sans-serif;
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-3xl bg-slate-800/60 backdrop-blur rounded-lg shadow-lg overflow-hidden">
        <div class="p-4 border-b border-slate-700 flex items-center justify-between">
            <h1 class="text-xl font-semibold">Chatbox (USE embedding)</h1>
            <div id="status" class="text-sm text-slate-400">Loading model...</div>
        </div>

        <div id="chat" class="h-[60vh] overflow-y-auto p-4 space-y-3 bg-gradient-to-b from-slate-900/20 to-transparent">
            <!-- messages -->
        </div>

        <div class="p-4 border-t border-slate-700">
            <div class="flex gap-3">
                <input id="msg"
                    class="flex-1 bg-slate-800/60 border border-slate-700 rounded px-3 py-2 focus:outline-none"
                    placeholder="G√µ c√¢u h·ªèi..." />
                <button id="send" class="px-4 py-2 rounded bg-emerald-500 hover:bg-emerald-600">G·ª≠i</button>
                <button id="trainAdd" class="px-3 py-2 rounded bg-sky-600 hover:bg-sky-700">Th√™m v√†o KB</button>
            </div>
            <div class="text-xs text-slate-400 mt-2">M√¥ h√¨nh s·ª≠ d·ª•ng <strong>Universal Sentence Encoder</strong>. ƒê√¢y l√†
                ph∆∞∆°ng ph√°p retrieval (so s√°nh embedding) ‚Äî ph√π h·ª£p v·ªõi FAQs, tr·ª£ gi√∫p, chatbot ƒë∆°n gi·∫£n.</div>
        </div>
    </div>

    <script>
        (async () => {
            const statusEl = document.getElementById('status');
            const chatEl = document.getElementById('chat');
            const input = document.getElementById('msg');
            const sendBtn = document.getElementById('send');
            const trainAddBtn = document.getElementById('trainAdd');

            statusEl.textContent = 'ƒêang t·∫£i model USE...';
            const model = await use.load();
            statusEl.textContent = 'Model s·∫µn s√†ng ‚úÖ';

            // --- Knowledge base m·∫∑c ƒë·ªãnh (c·∫∑p c√¢u h·ªèi -> ƒë√°p √°n) ---
            // B·∫°n c√≥ th·ªÉ thay b·∫±ng JSON t·∫£i t·ª´ server
            // === Knowledge Base m·ªü r·ªông: nhi·ªÅu c√°ch h·ªèi cho 1 c√¢u tr·∫£ l·ªùi ===
            let KB = [
                {
                    q: ["xin ch√†o", "ch√†o b·∫°n", "hi", "hello", "hey"],
                    a: "Xin ch√†o! M√¨nh l√† chatbot h·ªçc b·∫±ng TensorFlow.js."
                },
                {
                    q: ["b·∫°n l√† ai", "b·∫°n t√™n g√¨", "t√¥i ƒëang n√≥i chuy·ªán v·ªõi ai", "ai ƒëang tr·∫£ l·ªùi t√¥i"],
                    a: "T√¥i l√† m·ªôt chatbot h·ªçc m·∫´u c√¢u, kh√¥ng ph·∫£i AI t·ªïng h·ª£p ƒë√¢u nh√© üòÑ."
                },
                {
                    q: ["webassembly l√† g√¨", "wasm l√† g√¨", "gi·∫£i th√≠ch webassembly", "c√¥ng d·ª•ng c·ªßa webassembly"],
                    a: "WebAssembly (WASM) l√† m√£ nh·ªã ph√¢n gi√∫p code ch·∫°y nhanh trong tr√¨nh duy·ªát ‚Äî g·∫ßn nh∆∞ native."
                },
                {
                    q: ["tensorflow l√† g√¨", "tfjs l√† g√¨", "tensorflowjs d√πng ƒë·ªÉ l√†m g√¨"],
                    a: "TensorFlow.js l√† th∆∞ vi·ªán h·ªçc m√°y ch·∫°y tr·ª±c ti·∫øp trong tr√¨nh duy·ªát b·∫±ng JavaScript."
                },
                {
                    q: ["c·∫£m ∆°n", "c·∫£m ∆°n b·∫°n", "thanks", "tks", "thank you"],
                    a: "R·∫•t vui ƒë∆∞·ª£c gi√∫p b·∫°n üòÑ!"
                }
            ];

            // T·∫°o embedding cho KB (precompute)
            let kbEmbeddings = [];
            let kbAnswers = [];

            async function computeKBEmbeddings() {
                kbEmbeddings = [];
                kbAnswers = [];
                for (const item of KB) {
                    for (const question of item.q) {
                        const emb = await model.embed([question]);
                        kbEmbeddings.push(emb);
                        kbAnswers.push(item.a);
                    }
                }
            }
            await computeKBEmbeddings();

            // helper: append message
            function pushMessage(text, from = 'bot') {
                const wrap = document.createElement('div');
                wrap.className = from === 'bot' ? 'bg-slate-700/30 p-3 rounded max-w-[80%]' : 'ml-auto bg-emerald-600/20 p-3 rounded max-w-[80%]';
                wrap.innerHTML = `<div class="text-sm">${escapeHtml(text)}</div>`;
                chatEl.appendChild(wrap);
                chatEl.scrollTop = chatEl.scrollHeight;
            }

            // helper escape
            function escapeHtml(s) {
                return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
            }

            async function findBestResponse(message) {
                if (kbEmbeddings.length === 0) return null;
                const inputEmb = await model.embed([message]);
                let bestScore = -1;
                let bestIdx = -1;

                for (let i = 0; i < kbEmbeddings.length; i++) {
                    const score = tf.tidy(() => {
                        const a = kbEmbeddings[i];
                        const dot = a.dot(inputEmb.transpose()).arraySync()[0][0];
                        const normA = a.norm().arraySync();
                        const normB = inputEmb.norm().arraySync();
                        return dot / (normA * normB);
                    });
                    if (score > bestScore) {
                        bestScore = score;
                        bestIdx = i;
                    }
                }

                inputEmb.dispose();
                return { index: bestIdx, score: bestScore };
            }

            // default threshold
            const THRESHOLD = 0.60;

            async function handleUser(text) {
                pushMessage(text, "user");
                const res = await findBestResponse(text.toLowerCase());
                if (!res || res.score < THRESHOLD) {
                    pushMessage("Xin l·ªói, m√¨nh ch∆∞a hi·ªÉu r√µ c√¢u n√†y. B·∫°n c√≥ th·ªÉ h·ªèi l·∫°i theo c√°ch kh√°c kh√¥ng?", "bot");
                } else {
                    pushMessage(kbAnswers[res.index], "bot");
                }
            }

            // send on click / enter
            sendBtn.onclick = async () => {
                const t = input.value.trim();
                if (!t) return;
                input.value = '';
                await handleUser(t);
            };
            input.addEventListener('keydown', async (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendBtn.click();
                }
            });

            // Allow adding new KB entry (quick training)
            trainAddBtn.onclick = async () => {
                const q = prompt('Nh·∫≠p c√¢u h·ªèi m·∫´u (user):');
                if (!q) return;
                const a = prompt('Nh·∫≠p tr·∫£ l·ªùi t∆∞∆°ng ·ª©ng:');
                if (!a) return;
                KB.push({ q: q.toLowerCase(), a });
                // recompute embeddings (free; small KB)
                if (kbEmbeddings) kbEmbeddings.dispose();
                await computeKBEmbeddings();
                alert('ƒê√£ th√™m v√†o knowledge base.');
            };

            // preload some greeting
            pushMessage("Ch√†o b·∫°n ‚Äî m√¨nh l√† demo chatbox d√πng TensorFlow.js + USE. H·ªèi m√¨nh ƒëi·ªÅu g√¨ nh√©!", 'bot');

        })();
    </script>
</body>

</html>